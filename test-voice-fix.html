<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice & TTS Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/guideai.css" rel="stylesheet">
    <style>
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 2px solid #6f42c1;
            border-radius: 8px;
        }
        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        .status.warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Voice & TTS Functionality Test & Fix</h1>
        
        <div class="test-section">
            <h2>Browser Compatibility Check</h2>
            <div id="browserResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Microphone Test</h2>
            <div class="row">
                <div class="col-md-6">
                    <button id="testMicBtn" class="btn btn-primary mb-2">
                        <i class="fas fa-microphone"></i> Test Microphone
                    </button>
                    <div id="micResults"></div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="micInput">Recognized Text:</label>
                        <textarea id="micInput" class="form-control" rows="3" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Text-to-Speech Test</h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="ttsText">Text to Speak:</label>
                        <textarea id="ttsText" class="form-control" rows="3">Hello, this is a test of the text-to-speech functionality.</textarea>
                    </div>
                    <div class="form-group mb-3">
                        <label for="ttsVoice">Voice:</label>
                        <select id="ttsVoice" class="form-control">
                            <option value="nova">Nova</option>
                            <option value="alloy">Alloy</option>
                            <option value="echo">Echo</option>
                            <option value="fable">Fable</option>
                            <option value="onyx">Onyx</option>
                            <option value="shimmer">Shimmer</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="ttsSpeed">Speed:</label>
                        <input type="range" id="ttsSpeed" class="form-control-range" min="0.5" max="2.0" step="0.1" value="1.0">
                        <span id="speedValue">1.0x</span>
                    </div>
                    <button id="testTTSBtn" class="btn btn-success mb-2">
                        <i class="fas fa-volume-up"></i> Test TTS
                    </button>
                    <button id="stopTTSBtn" class="btn btn-warning mb-2">
                        <i class="fas fa-stop"></i> Stop TTS
                    </button>
                </div>
                <div class="col-md-6">
                    <div id="ttsResults"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>API Endpoint Test</h2>
            <button id="testAPIBtn" class="btn btn-info mb-2">
                <i class="fas fa-network-wired"></i> Test TTS API
            </button>
            <div id="apiResults"></div>
        </div>
        
        <div class="test-section">
            <h2>Accessibility Integration Test</h2>
            <button id="testAccessibilityBtn" class="btn btn-secondary mb-2">
                <i class="fas fa-universal-access"></i> Test Accessibility
            </button>
            <div id="accessibilityResults"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let recognition = null;
        let currentAudio = null;
        let accessibilitySystem = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeTests();
        });
        
        function initializeTests() {
            // Initialize speed control
            const speedRange = document.getElementById('ttsSpeed');
            const speedValue = document.getElementById('speedValue');
            speedRange.addEventListener('input', (e) => {
                speedValue.textContent = e.target.value + 'x';
            });
            
            // Test buttons
            document.getElementById('testMicBtn').addEventListener('click', testMicrophone);
            document.getElementById('testTTSBtn').addEventListener('click', testTTS);
            document.getElementById('stopTTSBtn').addEventListener('click', stopTTS);
            document.getElementById('testAPIBtn').addEventListener('click', testTTSAPI);
            document.getElementById('testAccessibilityBtn').addEventListener('click', testAccessibility);
            
            // Run initial checks
            checkBrowserCompatibility();
        }
        
        function checkBrowserCompatibility() {
            const results = document.getElementById('browserResults');
            const tests = [
                {
                    name: 'Speech Recognition',
                    test: () => 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
                    message: 'Speech recognition is supported'
                },
                {
                    name: 'Speech Synthesis',
                    test: () => 'speechSynthesis' in window,
                    message: 'Speech synthesis is supported'
                },
                {
                    name: 'Fetch API',
                    test: () => 'fetch' in window,
                    message: 'Fetch API is supported'
                },
                {
                    name: 'Audio API',
                    test: () => 'Audio' in window,
                    message: 'Audio API is supported'
                }
            ];
            
            results.innerHTML = '';
            tests.forEach(test => {
                const result = document.createElement('div');
                result.className = `status ${test.test() ? 'success' : 'error'}`;
                result.innerHTML = `<strong>${test.name}:</strong> ${test.message}`;
                results.appendChild(result);
            });
        }
        
        function testMicrophone() {
            const results = document.getElementById('micResults');
            const input = document.getElementById('micInput');
            
            results.innerHTML = '<div class="status info">Initializing microphone...</div>';
            
            // Check if speech recognition is supported
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                results.innerHTML = '<div class="status error">Speech recognition not supported in this browser</div>';
                return;
            }
            
            // Initialize speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                results.innerHTML = '<div class="status success">Listening... Speak now!</div>';
                document.getElementById('testMicBtn').innerHTML = '<i class="fas fa-stop"></i> Stop Listening';
                document.getElementById('testMicBtn').classList.remove('btn-primary');
                document.getElementById('testMicBtn').classList.add('btn-danger');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                results.innerHTML = '<div class="status success">Speech recognized: ' + transcript + '</div>';
            };
            
            recognition.onend = () => {
                results.innerHTML = '<div class="status info">Microphone stopped</div>';
                document.getElementById('testMicBtn').innerHTML = '<i class="fas fa-microphone"></i> Test Microphone';
                document.getElementById('testMicBtn').classList.remove('btn-danger');
                document.getElementById('testMicBtn').classList.add('btn-primary');
            };
            
            recognition.onerror = (event) => {
                results.innerHTML = '<div class="status error">Error: ' + event.error + '</div>';
                document.getElementById('testMicBtn').innerHTML = '<i class="fas fa-microphone"></i> Test Microphone';
                document.getElementById('testMicBtn').classList.remove('btn-danger');
                document.getElementById('testMicBtn').classList.add('btn-primary');
            };
            
            recognition.start();
        }
        
        async function testTTS() {
            const results = document.getElementById('ttsResults');
            const text = document.getElementById('ttsText').value;
            const voice = document.getElementById('ttsVoice').value;
            const speed = parseFloat(document.getElementById('ttsSpeed').value);
            
            if (!text.trim()) {
                results.innerHTML = '<div class="status error">Please enter text to speak</div>';
                return;
            }
            
            results.innerHTML = '<div class="status info">Testing TTS...</div>';
            
            try {
                // Stop any current audio
                stopTTS();
                
                // Try OpenAI TTS first
                const response = await fetch('api/tts.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voice: voice,
                        language: 'en',
                        speed: speed
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.audio) {
                        // Create and play audio
                        const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);
                        audio.volume = 1.0;
                        
                        currentAudio = audio;
                        
                        audio.onended = () => {
                            results.innerHTML = '<div class="status success">TTS playback completed</div>';
                            currentAudio = null;
                        };
                        
                        audio.onerror = (error) => {
                            results.innerHTML = '<div class="status error">Audio playback error: ' + error.message + '</div>';
                            currentAudio = null;
                        };
                        
                        await audio.play();
                        results.innerHTML = '<div class="status success">Playing TTS with OpenAI voice: ' + voice + '</div>';
                    } else {
                        throw new Error(data.error || 'Invalid TTS response');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('TTS Error:', error);
                results.innerHTML = '<div class="status warning">OpenAI TTS failed, trying browser synthesis...</div>';
                
                // Fallback to browser speech synthesis
                try {
                    if ('speechSynthesis' in window) {
                        speechSynthesis.cancel();
                        
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'en-US';
                        utterance.rate = speed;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        utterance.onend = () => {
                            results.innerHTML = '<div class="status success">Browser TTS completed</div>';
                        };
                        
                        utterance.onerror = (error) => {
                            results.innerHTML = '<div class="status error">Browser TTS error: ' + error.error + '</div>';
                        };
                        
                        speechSynthesis.speak(utterance);
                        results.innerHTML = '<div class="status success">Playing TTS with browser synthesis</div>';
                    } else {
                        throw new Error('Browser speech synthesis not supported');
                    }
                } catch (fallbackError) {
                    results.innerHTML = '<div class="status error">All TTS methods failed: ' + fallbackError.message + '</div>';
                }
            }
        }
        
        function stopTTS() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            
            document.getElementById('ttsResults').innerHTML = '<div class="status info">TTS stopped</div>';
        }
        
        async function testTTSAPI() {
            const results = document.getElementById('apiResults');
            
            results.innerHTML = '<div class="status info">Testing TTS API endpoint...</div>';
            
            try {
                const response = await fetch('api/tts.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: 'Test message',
                        voice: 'nova',
                        language: 'en',
                        speed: 1.0
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    results.innerHTML = `
                        <div class="status success">
                            <strong>TTS API Working!</strong><br>
                            Voice: ${data.voice}<br>
                            Format: ${data.format}<br>
                            Text Length: ${data.text_length}<br>
                            Timestamp: ${data.timestamp}
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="status error">
                            <strong>TTS API Error:</strong><br>
                            ${data.error || 'Unknown error'}<br>
                            ${data.message || ''}
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `
                    <div class="status error">
                        <strong>Network Error:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        async function testAccessibility() {
            const results = document.getElementById('accessibilityResults');
            
            results.innerHTML = '<div class="status info">Testing accessibility integration...</div>';
            
            // Check if accessibility system is available
            if (typeof GuideAIAccessibility !== 'undefined') {
                try {
                    accessibilitySystem = new GuideAIAccessibility();
                    
                    // Test TTS functionality
                    await accessibilitySystem.speakText('Accessibility system is working correctly.');
                    
                    results.innerHTML = `
                        <div class="status success">
                            <strong>Accessibility System Working!</strong><br>
                            TTS: Functional<br>
                            Voice: ${accessibilitySystem.preferences.ttsVoice}<br>
                            Speed: ${accessibilitySystem.preferences.ttsSpeed}x<br>
                            Read Aloud: ${accessibilitySystem.preferences.readAloud ? 'Enabled' : 'Disabled'}
                        </div>
                    `;
                } catch (error) {
                    results.innerHTML = `
                        <div class="status error">
                            <strong>Accessibility System Error:</strong><br>
                            ${error.message}
                        </div>
                    `;
                }
            } else {
                results.innerHTML = `
                    <div class="status warning">
                        <strong>Accessibility System Not Found</strong><br>
                        Make sure accessibility.js is loaded
                    </div>
                `;
            }
        }
    </script>
</body>
</html> 